#!mesosphere/dispatch-starlark:v0.5-beta2
# vi:syntax=python

load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.4", "gitResource", "pullRequest", "push", "secretVar", "clean", "imageResource", "volume")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/docker@0.0.4", "dindTask")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/kaniko@0.0.4", "kaniko")
load("github.com/mesosphere/cluster-claim-controller/starlark/claim@master", "make_kind_cluster", "fetch_kubeconfig", "cleanup")

git_resource_name = "kba-git-resource"
cluster_name = "test-cluster"

git = gitResource(git_resource_name)

dindTask("dispatch-integration-test",
         inputs=[git_resource_name],
         steps=[
             v1.Container(
                 name="fetch-master",
                 workingDir="/workspace/{git_resource_name}".format(git_resource_name=git_resource_name),
                 args=["git", "fetch", "origin", "master"]),

             v1.Container(
                 name="dispatch-integration-test",
                 image="mesosphere/kubeaddons-ci:dispatch@sha256:80a6f3c8775133b4ad2fab3d44ab4fbb4b541dbc03fcdb296b13f67611427d8c",
                 command=["/entrypoint.sh", "make", "dispatch-test"],
                 workingDir="/workspace/{git_resource_name}".format(git_resource_name=git_resource_name),
                 env=[k8s.corev1.EnvVar(name="DISPATCH_CI", value="true"),
                      k8s.corev1.EnvVar(name="AWS_REGION", value="us-west-2"),
                      k8s.corev1.EnvVar(name="AWS_ACCESS_KEY_ID",
                                        valueFrom=secretVar("d2iq-dispatch-aws-creds",
                                                            "AWS_ACCESS_KEY_ID")),
                      k8s.corev1.EnvVar(name="AWS_SECRET_ACCESS_KEY",
                                        valueFrom=secretVar("d2iq-dispatch-aws-creds",
                                                            "AWS_SECRET_ACCESS_KEY")),
                      k8s.corev1.EnvVar(name="SSH_KEY_BASE64",
                                        valueFrom=secretVar("d2iq-dispatch-git-ssh-base64",
                                                            "ssh-privatekey-base64"))
                      ]
             )
         ]
         )


kind_cluster=make_kind_cluster(cluster_name, git_resource_name)

task("test", inputs=[git_resource_name], deps=[kind_cluster], steps=[
    fetch_kubeconfig(cluster_name, git_resource_name),
    k8s.corev1.Container(
        name = "test",
        image = "mesosphere/kubeaddons-ci:latest",
        workingDir = "/workspace/{}/".format(git),
        command = ["/bin/bash", "-c"],
        args = ["""
            cat ./kubeconfig
            curl -L https://go.kubebuilder.io/dl/2.3.0/linux/amd64 | tar -xz -C /tmp/ && \
    mv /tmp/kubebuilder_2.3.0_linux_amd64 /usr/local/kubebuilder && \
            make test
        """],
        env = [
            k8s.corev1.EnvVar(name="GOPRIVATE", value="github.com/mesosphere"),
            k8s.corev1.EnvVar(name="SSH_KEY_BASE64", valueFrom=secretVar("d2iq-dispatch-git-ssh-base64", "ssh-privatekey-base64")),
            k8s.corev1.EnvVar(name="USE_EXISTING", value="1")
        ]
    )
])

action(tasks=["dispatch-integration-test", "test"], on=pullRequest())
action(tasks=["dispatch-integration-test", "test"], on=pullRequest(chatops=["test"]))
